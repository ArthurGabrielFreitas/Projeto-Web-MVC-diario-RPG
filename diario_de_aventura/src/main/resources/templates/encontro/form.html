<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head(${encontro.id != null ? 'Editar encontro' : 'Novo encontro'})}"></head>

<body>
<header th:replace="~{fragments/header :: header}"></header>
<div th:replace="~{fragments/messages :: messages}"></div>

<div class="container mt-4">

    <h2 class="mb-4">Novo Encontro</h2>

    <form th:action="@{/encontros/salvar}" th:object="${encontro}" method="post">

        <input type="hidden" th:field="*{id}" />
        <!-- Sessão -->
    <select class="form-select" th:field="*{sessao.id}">
        <option value="">Sem sessão</option>
        <option th:each="s : ${sessoes}"
            th:value="${s.id}"
            th:text="${s.titulo}">
        </option>
    </select>


        <!-- Duração -->
        <div class="mb-3">
            <label class="form-label">Duração (turnos) *</label>
            <input type="number"
                   class="form-control"
                   th:field="*{duracaoTurnos}"
                   min="1"
                   required>
        </div>

        <!-- Descrição -->
        <div class="mb-4">
            <label class="form-label">Descrição</label>
            <textarea class="form-control"
                      th:field="*{descricao}"
                      rows="3"></textarea>
        </div>

        <hr>

        <h4 class="mb-3">Participantes do Encontro</h4>

        <!-- PARTICIPAÇÕES -->
        <table class="table table-bordered align-middle">
            <thead class="table-light">
            <tr>
                <th>Tipo</th>
                <th>Participação</th>
                <th>Participante</th>
                <th>Morte</th>
                <th>Último Golpe</th>
                <th>Anotações</th>
            </tr>
            </thead>

            <tbody>

            <!-- PERSONAGENS -->
            <tr th:each="p, stat : ${personagens}">
                <td>Personagem</td>

                <td class="text-center">
                    <!-- hidden fallback para false -->
                    <input type="hidden" th:name="participacoes[__${stat.index}__].participa" th:value="false" />
              <input type="checkbox" class="form-check-input"
                  th:name="participacoes[__${stat.index}__].participa"
                  th:value="true"
                  th:checked="${encontro.participacoes.size() > stat.index ? encontro.participacoes[stat.index].participa : false}" />
                </td>

                                <td>
                            <input type="hidden"
                                    th:name="participacoes[__${stat.index}__].personagem.id"
                                    th:value="${p.id}"/>
                <input type="hidden"
                    th:name="participacoes[__${stat.index}__].id"
                    th:value="${encontro.participacoes.size() > stat.index ? encontro.participacoes[stat.index].id : ''}" />
                                        <span th:text="${p.nome}"></span>
                                </td>

                                <td class="text-center">
                            <input type="checkbox"
                                    class="form-check-input"
                                    th:name="participacoes[__${stat.index}__].morte"
                                    th:checked="${encontro.participacoes.size() > stat.index ? encontro.participacoes[stat.index].morte : false}">
                                </td>

                                <td class="text-center">
                            <input type="checkbox"
                                    class="form-check-input"
                                    th:name="participacoes[__${stat.index}__].ultimoGolpe"
                                    th:checked="${encontro.participacoes.size() > stat.index ? encontro.participacoes[stat.index].ultimoGolpe : false}">
                                </td>

                                <td>
                            <input type="text"
                                    class="form-control"
                                    th:name="participacoes[__${stat.index}__].anotacoes"
                                    th:value="${encontro.participacoes.size() > stat.index ? encontro.participacoes[stat.index].anotacoes : ''}">
                                </td>
            </tr>

            <!-- AMEAÇAS -->
            <tr th:each="a, statA : ${ameacas}">
                <td>Ameaça</td>

                <td class="text-center">
                    <!-- hidden fallback para false -->
                    <input type="hidden" th:name="participacoes[__${statA.index + personagens.size()}__].participa" th:value="false" />
              <input type="checkbox" class="form-check-input"
                  th:name="participacoes[__${statA.index + personagens.size()}__].participa"
                  th:value="true"
                  th:checked="${encontro.participacoes.size() > statA.index + personagens.size() ? encontro.participacoes[statA.index + personagens.size()].participa : false}" />
                </td>

                                <td>
                            <input type="hidden"
                                    th:name="participacoes[__${statA.index + personagens.size()}__].ameaca.id"
                                    th:value="${a.id}"/>
                <input type="hidden"
                    th:name="participacoes[__${statA.index + personagens.size()}__].id"
                    th:value="${encontro.participacoes.size() > statA.index + personagens.size() ? encontro.participacoes[statA.index + personagens.size()].id : ''}" />
                                        <span th:text="${a.nome}"></span>
                                </td>

                <td class="text-center">
                    <input type="checkbox"
                           class="form-check-input"
                           th:name="participacoes[__${statA.index + personagens.size()}__].morte"
                           th:checked="${encontro.participacoes.size() > statA.index + personagens.size() ? encontro.participacoes[statA.index + personagens.size()].morte : false}">
                </td>

                <td class="text-center">
                    <input type="checkbox"
                           class="form-check-input"
                           th:name="participacoes[__${statA.index + personagens.size()}__].ultimoGolpe"
                           th:checked="${encontro.participacoes.size() > statA.index + personagens.size() ? encontro.participacoes[statA.index + personagens.size()].ultimoGolpe : false}">
                </td>

                <td>
                    <input type="text"
                           class="form-control"
                           th:name="participacoes[__${statA.index + personagens.size()}__].anotacoes"
                           th:value="${encontro.participacoes.size() > statA.index + personagens.size() ? encontro.participacoes[statA.index + personagens.size()].anotacoes : ''}">
                </td>
            </tr>

            </tbody>
        </table>

        <div class="mt-4">
            <button type="submit" class="btn btn-success">
                Salvar Encontro
            </button>
            <a th:href="@{/encontros}" class="btn btn-secondary">
                Cancelar
            </a>
        </div>

    </form>
</div>

<footer th:replace="fragments/footer :: footer"></footer>
</body>
</html>
