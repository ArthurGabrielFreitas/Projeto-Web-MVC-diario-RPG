<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head(${encontro.id != null ? 'Editar encontro' : 'Novo encontro'})}"></head>

<body>
<header th:replace="~{fragments/header :: header}"></header>
<div th:replace="~{fragments/messages :: messages}"></div>

<div class="container mt-4">

    <h2 class="mb-4">Novo Encontro</h2>

    <form th:action="@{/encontros/salvar}" th:object="${encontro}" method="post">

        <input type="hidden" th:field="*{id}" />
        <!-- Sessão -->
    <select class="form-select" th:field="*{sessao.id}">
        <option value="">Sem sessão</option>
        <option th:each="s : ${sessoes}"
            th:value="${s.id}"
            th:text="${s.titulo}">
        </option>
    </select>


        <!-- Duração -->
        <div class="mb-3">
            <label class="form-label">Duração (turnos) *</label>
            <input type="number"
                   class="form-control"
                   th:field="*{duracaoTurnos}"
                   min="1"
                   required>
        </div>

        <!-- Descrição -->
        <div class="mb-4">
            <label class="form-label">Descrição</label>
            <textarea class="form-control"
                      th:field="*{descricao}"
                      rows="3"></textarea>
        </div>

        <hr>

        <h4 class="mb-3">Participantes do Encontro</h4>

        <!-- PARTICIPAÇÕES -->
        <table class="table table-bordered align-middle">
            <thead class="table-light">
            <tr>
                <th>Tipo</th>
                <th>Participação</th>
                <th>Participante</th>
                <th>Morte</th>
                <th>Último Golpe</th>
                <th>Anotações</th>
            </tr>
            </thead>

            <tbody>

            <!-- PERSONAGENS -->
            <tr th:each="p : ${personagens}">
                <td>Personagem</td>

                <td class="text-center">
                    <!-- checkbox que envia o id do personagem quando marcado -->
                    <input type="checkbox" class="form-check-input"
                           th:name="personagensSelecionados"
                           th:value="${p.id}"
                           th:checked="${mapParticipacaoPorPersonagem[p.id] != null ? mapParticipacaoPorPersonagem[p.id].participa : false}" />
                    <!-- se já havia participação, enviar o id dela para permitir atualização -->
                    <input type="hidden" th:if="${mapParticipacaoPorPersonagem[p.id] != null}"
                           th:name="${'participacaoId_personagem_' + p.id}"
                           th:value="${mapParticipacaoPorPersonagem[p.id].id}" />
                </td>

                <td>
                    <input type="hidden" th:name="${'personagemId_' + p.id}" th:value="${p.id}" />
                    <span th:text="${p.nome}"></span>
                </td>

                <td class="text-center">
                    <input type="checkbox" class="form-check-input"
                           th:name="${'morte_personagem_' + p.id}"
                           th:checked="${mapParticipacaoPorPersonagem[p.id] != null ? mapParticipacaoPorPersonagem[p.id].morte : false}" />
                </td>

                <td class="text-center">
                    <input type="checkbox" class="form-check-input"
                           th:name="${'ultimoGolpe_personagem_' + p.id}"
                           th:checked="${mapParticipacaoPorPersonagem[p.id] != null ? mapParticipacaoPorPersonagem[p.id].ultimoGolpe : false}" />
                </td>

                <td>
                    <input type="text" class="form-control"
                           th:name="${'anotacoes_personagem_' + p.id}"
                           th:value="${mapParticipacaoPorPersonagem[p.id] != null ? mapParticipacaoPorPersonagem[p.id].anotacoes : ''}" />
                </td>
            </tr>

            <!-- AMEAÇAS -->
            <tr th:each="a : ${ameacas}">
                <td>Ameaça</td>

                <td class="text-center">
                    <input type="checkbox" class="form-check-input"
                           th:name="ameacasSelecionadas"
                           th:value="${a.id}"
                           th:checked="${mapParticipacaoPorAmeaca[a.id] != null ? mapParticipacaoPorAmeaca[a.id].participa : false}" />
                    <input type="hidden" th:if="${mapParticipacaoPorAmeaca[a.id] != null}"
                           th:name="${'participacaoId_ameaca_' + a.id}"
                           th:value="${mapParticipacaoPorAmeaca[a.id].id}" />
                </td>

                <td>
                    <input type="hidden" th:name="${'ameacaId_' + a.id}" th:value="${a.id}" />
                    <span th:text="${a.nome}"></span>
                </td>

                <td class="text-center">
                    <input type="checkbox" class="form-check-input"
                           th:name="${'morte_ameaca_' + a.id}"
                           th:checked="${mapParticipacaoPorAmeaca[a.id] != null ? mapParticipacaoPorAmeaca[a.id].morte : false}" />
                </td>

                <td class="text-center">
                    <input type="checkbox" class="form-check-input"
                           th:name="${'ultimoGolpe_ameaca_' + a.id}"
                           th:checked="${mapParticipacaoPorAmeaca[a.id] != null ? mapParticipacaoPorAmeaca[a.id].ultimoGolpe : false}" />
                </td>

                <td>
                    <input type="text" class="form-control"
                           th:name="${'anotacoes_ameaca_' + a.id}"
                           th:value="${mapParticipacaoPorAmeaca[a.id] != null ? mapParticipacaoPorAmeaca[a.id].anotacoes : ''}" />
                </td>
            </tr>

            </tbody>
        </table>

        <div class="mt-4">
            <button type="submit" class="btn btn-success">
                Salvar Encontro
            </button>
            <a th:href="@{/encontros}" class="btn btn-secondary">
                Cancelar
            </a>
        </div>

    </form>
</div>

<footer th:replace="fragments/footer :: footer"></footer>
</body>
</html>
